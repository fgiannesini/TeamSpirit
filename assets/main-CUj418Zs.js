import{s as N,a as O,b as B}from"./session-storage-Om7Yksbp.js";const f=(t,e)=>{const n=document.createElement("input");return n.id=t,n.type="number",n.min="1",n.value=e.toString(),n},p=(t,e)=>{const n=document.createElement("label");return n.textContent=t,n.htmlFor=e,n},T=t=>Math.floor(Math.random()*t)+1,U=t=>{const e=document.createElement("span");e.id=`dev-identifier-${t}`,e.textContent=t.toString();const n=`power-input-${t}`,r=p("Power",n),i=f(n,T(5)),o=document.createElement("div");return o.append(e,r,i),o},F=t=>{const e=document.createElement("span");e.id=`user-story-identifier-${t}`,e.textContent=t.toString();const n=`complexity-input-${t}`,r=p("Complexity",n),i=T(10),o=f(n,i),s=`review-complexity-input-${t}`,a=p("Review complexity",s),d=f(s,Math.max(1,T(i-1))),c=`priority-input-${t}`,m=p("Priority",c),l=f(c,T(6)-1),v=document.createElement("div");return v.append(e,r,o,a,d,m,l),v},_=t=>{const e=`team-modificator-event-${t}-off-input`,n=p("Off",e),r=f(e,3),i=`team-modificator-event-${t}-in-input`,o=p("In",i),s=f(i,5),a=`team-modificator-event-${t}-thread-name-input`,d=p("Thread name",a),c=document.createElement("input");c.id=a;const m=document.createElement("button");m.textContent="Remove",m.id=`remove-event-button-${t}`,m.addEventListener("click",v=>{v.target.parentElement?.remove()});const l=document.createElement("div");return l.id=`team-modificator-event-${t}`,l.append(d,c,n,r,o,s,m),l},k=t=>{const e=`bug-generator-event-${t}-time-input`,n=p("Time",e),r=f(e,3),i=`bug-generator-event-${t}-complexity-input`,o=p("Complexity",i),s=f(i,1),a=`bug-generator-event-${t}-review-complexity-input`,d=p("Review complexity",a),c=f(a,1),m=`bug-generator-event-${t}-priority-input`,l=p("Priority",m),v=f(m,0),h=document.createElement("button");h.textContent="Remove",h.id=`remove-event-button-${t}`,h.addEventListener("click",q=>{q.target.parentElement?.remove()});const x=document.createElement("div");return x.id=`bug-generator-event-${t}`,x.append(n,r,o,s,d,c,l,v,h),x},G=t=>{const e=`priority-modificator-event-${t}-time-input`,n=p("Time",e),r=f(e,2),i=`priority-modificator-event-${t}-id-input`,o=p("Id",i),s=f(i,0),a=`priority-modificator-event-${t}-priority-input`,d=p("Priority",a),c=f(a,3),m=document.createElement("button");m.textContent="Remove",m.id=`remove-event-button-${t}`,m.addEventListener("click",v=>{v.target.parentElement?.remove()});const l=document.createElement("div");return l.id=`team-modificator-event-${t}`,l.append(o,s,d,c,n,r,m),l},z=(t,e,n,r)=>{const o=(6-n)/5,a=t/5,d=.4*o*a,c=2+t,m=c/2,l=c/2.5,v=Math.exp(-(((e-m)/l)**2)),h=1.5*Math.exp(-.4*r);return d*v*h},K=(t,e)=>Math.max(0,t+(Math.floor(e()*5)-2)),V={generate(t,e,n){return[]}};class W{bugEvents;bugCount=0;constructor(e){this.bugEvents=e}generate(e,n,r){const i=b(e).length;return this.bugEvents.filter(o=>o.time===r).map(o=>{const s={id:i+this.bugCount,name:`bug-${this.bugCount}`,complexity:o.complexity,progression:0,review:{reviewers:new Map,reviewComplexity:o.reviewComplexity},state:"Todo",threadId:void 0,timeDone:0,priority:o.priority};return this.bugCount++,s})}}class X{bugCount=0;creationRandomProvider;complexityRandomProvider;priorityRandomProvider;constructor(e,n,r){this.creationRandomProvider=e,this.complexityRandomProvider=n,this.priorityRandomProvider=r}generate(e,n,r){return e.userStoriesDone.map(i=>le(this.creationRandomProvider,i,n,r)?i:null).filter(i=>i!==null).map((i,o)=>{const s=b(e).length+o,a=`bug-${this.bugCount++}`,d=this.complexityRandomProvider();return{id:s,name:a,complexity:Math.max(1,Math.floor(d*i.complexity)),progression:0,review:{reviewComplexity:Math.max(1,Math.floor(d*i.review.reviewComplexity)),reviewers:new Map},threadId:void 0,state:"Todo",timeDone:0,priority:K(i.priority,this.priorityRandomProvider)}})}}const D={reviewComplexity:1,reviewers:new Map},j=(t,e)=>t.reviewers.get(e.id)??0,H=(t,e,n)=>{const{reviewers:r}=t;return r.size<n&&!r.has(e.id)},J=(t,e,n)=>{const r=t.reviewers,i=r.get(e.id);return r.has(e.id)&&i!==n},Q=(t,e,n)=>t.reviewers.size>=n&&t.reviewers.values().filter(r=>r===e).toArray().length>=n,Y=(t,e,n)=>n!==t.reviewers.size&&t.reviewers.values().every(r=>r===e),Z=(t,e,n)=>{const r=new Map(t.reviewers).set(e.id,n);return{...t,reviewers:r}},I={id:-1,name:"idle",complexity:0,progression:0,review:D,threadId:void 0,state:"Done",timeDone:0,priority:0},ee=(t,e)=>({...t,progression:Math.min(t.progression+e.power,t.complexity),threadId:e.id,state:"InProgress"}),te=(t,e,n)=>({...t,state:"Done",threadId:e,timeDone:n}),ne=(t,e)=>({...t,state:"Done",timeDone:e}),R=(t,e)=>({...t,state:"ToReview",threadId:e}),re=(t,e)=>{const n=t.review,r=j(n,e),i=Math.min(r+e.power,n.reviewComplexity),o=Z(n,e,i);return{...t,state:"Review",review:o}},ie=t=>t.progression===t.complexity,S=(t,e)=>Q(t.review,t.review.reviewComplexity,e),oe=(t,e)=>t.state==="InProgress"&&t.threadId===e.id,se=(t,e)=>t.state!=="Review"||t.threadId===e.id?!1:J(t.review,e,t.review.reviewComplexity),ae=(t,e,n)=>t.state==="Review"&&t.threadId!==e.id&&H(t.review,e,n),ce=(t,e)=>t.state==="ToReview"&&t.threadId!==e.id,de=t=>t.state==="Todo";class A{userStoriesRemaining;userStoriesDone=[];constructor(e){this.userStoriesRemaining=e}}const b=t=>[...t.userStoriesRemaining,...t.userStoriesDone],me=(t,e,n)=>{const r=[...new Set(t.userStoriesRemaining.map(o=>o.priority))].toSorted((o,s)=>s-o);let i;for(const o of r){const s=t.userStoriesRemaining.filter(a=>a.priority===o);if(i=s.find(a=>oe(a,e)),i||(i=s.find(a=>se(a,e))),i||(i=s.find(a=>ae(a,e,n))),!i){let a=Number.MAX_VALUE;s.filter(d=>ce(d,e)).forEach(d=>{const c=Math.abs(d.review.reviewComplexity-e.power);c<a&&(a=c,i=d)})}if(!i){let a=Number.MAX_VALUE;s.filter(de).forEach(d=>{const c=Math.abs(d.complexity-e.power);c<a&&(a=c,i=d)})}if(i)break}if(i){const o=t.userStoriesRemaining.indexOf(i);return t.userStoriesRemaining.splice(o,1)[0]}return I},ue=(t,e)=>t.userStoriesRemaining.filter(n=>n.state==="Review").filter(n=>Y(n.review,n.review.reviewComplexity,e)),E=(t,e)=>{t.state==="Done"?e.userStoriesDone.push(t):e.userStoriesRemaining.push(t)},pe=t=>t.userStoriesRemaining.length>0,le=(t,e,n,r)=>{const i=t(),o=n.getEffectiveThreads().find(s=>s.id===e.threadId)?.power??0;return i<z(e.complexity,r-e.timeDone,o,e.review.reviewers.size)},fe=(t,e)=>{const n=b(t).flatMap(i=>[{time:1,id:i.id,name:i.name,action:"CreateUserStory"},{time:1,id:i.id,value:i.priority,action:"ChangePriority"}]);return[...e.getEffectiveThreads().map(i=>({time:1,id:i.id,name:i.name,action:"CreateThread"})),...n]},w=(t,e,n)=>({time:t,userStoryId:e.id,threadId:n,state:e.state}),ve=(t,e,n)=>{const r=[],i=[],o=t.getEffectiveActiveThreads().toSorted((s,a)=>a.power-s.power);for(const s of o){const a=me(e,s,t.getReviewersNeeded());if(a===I){I.threadId=s.id,r.push(w(n,I,s.id));continue}if(["ToReview","Review"].includes(a.state)){const d=re(a,s);if(r.push(w(n,d,s.id)),S(d,t.getReviewersNeeded())){const c=te(a,d.threadId,n);r.push(w(n,c,c.threadId)),i.push(c)}else E(d,e)}else if(["Todo","InProgress"].includes(a.state)){const d=ee(a,s);if(r.push(w(n,d,s.id)),!ie(d))i.push(d);else if(S(d,t.getReviewersNeeded())){let c=ne(d,n);c=t.addImplicitsReviewers(c),r.push(w(n,c,s.id)),i.push(c)}else{const c=R(d,s.id);r.push(w(n,c,s.id)),i.push(c)}}}return ue(e,t.getReviewersNeeded()).forEach(s=>{const a=R(s,s.threadId);r.push(w(n,a,s.threadId))}),i.forEach(s=>{E(s,e)}),r},he=(t,e,n,r)=>{const i=[];let o=1,s=e;const a=fe(t,s);for(;pe(t);){n.generate(t,s,o).forEach(m=>{a.push({time:o,name:m.name,id:m.id,action:"CreateUserStory"},{time:o,value:m.priority,id:m.id,action:"ChangePriority"}),E(m,t)});const d=r.setThreadsOff(s,o);s=d.team,d.newThreadsOff.forEach(m=>{a.push({time:o,id:m.id,action:"ThreadOff"})});const c=r.setThreadsIn(s,o);s=c.team,c.newThreadsIn.forEach(m=>{a.push({time:o,id:m.id,action:"ThreadIn"})}),i.push(...ve(s,t,o)),o++,s=s.updateTimes()}return{timeEvents:i,structureEvents:a}},we=t=>t.reduce((n,r)=>n+r,0)/t.length,ge=t=>{const e=new Map,n=[],r=[];let i=1;for(;;){const o=t.filter(c=>c.time===i);if(o.length===0)break;const s=new Set(o.filter(c=>c.state==="InProgress").map(c=>c.userStoryId));for(const c of s)e.has(c)||e.set(c,0);e.forEach((c,m)=>{e.set(m,c+1)});const a=new Set(o.filter(c=>c.state==="Done").map(c=>c.userStoryId));for(const c of a){const m=e.get(c);m&&n.push(m),e.delete(c)}const d=we(n);r.push({time:i,leadTime:d}),i++}return r},C=t=>{const e=t.map(r=>r.power).reduce((r,i)=>r+i,0);return[{id:0,name:"mob",power:Math.round(e/t.length),inTime:0,offTime:0,off:!1}]},L=t=>t.map(e=>e.off?{...e,offTime:e.offTime+1}:{...e,inTime:e.inTime+1});class g{threads=[];reviewersNeeded;constructor(e,n=Math.ceil(e.length/2)){this.threads=e,this.reviewersNeeded=n}addImplicitsReviewers(e){return e}updateTimes(){return new g(L(this.threads),this.reviewersNeeded)}getReviewersNeeded(){const e=this.getEffectiveActiveThreads().length;return this.reviewersNeeded>=e?e-1:this.reviewersNeeded}setOff(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!0,inTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new g(i,this.reviewersNeeded)}setIn(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!1,offTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new g(i,this.reviewersNeeded)}getAllActiveThreads(){return this.threads.filter(e=>!e.off)}getEffectiveActiveThreads(){return this.getAllActiveThreads()}getEffectiveThreads(){return this.getEffectiveActiveThreads()}getThreadsOff(){return this.threads.filter(e=>e.off)}}class y{threads;constructor(e){this.threads=e}addImplicitsReviewers(e){const n=this.getAllActiveThreads();n.shift();const r=new Map(n.map(i=>[i.id,e.review.reviewComplexity]));return{...e,review:{...e.review,reviewers:r}}}getThreadsOff(){return this.threads.filter(e=>e.off)}getReviewersNeeded(){return 0}setOff(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!0,inTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new y(i)}setIn(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!1,offTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new y(i)}getAllActiveThreads(){return this.threads.filter(e=>!e.off)}getEffectiveActiveThreads(){return C(this.getAllActiveThreads())}getEffectiveThreads(){return C(this.threads)}updateTimes(){return new y(L(this.threads))}}const ye=t=>{const r={};for(const i of t){const o=Math.min(1,(i.inTime/30)**2.2),s=(6-i.power)/5;r[i.id]=Math.min(.5,o*s*.5)}return r},Te=t=>{const e={};for(const n of t){if(n.offTime<=4){e[n.id]=.3+.2*n.offTime/4;continue}if(n.offTime<=10){e[n.id]=.2;continue}const r=1,i=.2+(1-Math.exp(-.3*(n.offTime-10)));e[n.id]=Math.min(i,r)}return e};class Ie{randomProvider;constructor(e){this.randomProvider=e}setThreadsIn(e,n){let r=e;const i=e.getThreadsOff(),o=[],s=Te(i);return i.forEach(a=>{this.randomProvider()<s[a.id]&&(o.push({id:a.id,name:a.name}),r=e.setIn(a.id))}),{team:r,newThreadsIn:o}}setThreadsOff(e,n){const r=e.getAllActiveThreads();if(r.length===1)return{team:e,newThreadsOff:[]};let i=e;const o=[],s=ye(r);return r.forEach(a=>{this.randomProvider()<s[a.id]&&(o.push({id:a.id,name:a.name}),i=e.setOff(a.id))}),{team:i,newThreadsOff:o}}}const xe={setThreadsIn(t){return{newThreadsIn:[],team:t}},setThreadsOff(t){return{newThreadsOff:[],team:t}}};class Ee{events;constructor(e){this.events=e}setThreadsIn(e,n){let r=e;const i=[];for(const o of this.events)if(o.in===n){const s=r.getThreadsOff().find(({name:a})=>a===o.threadName);s!==void 0&&(r=r.setIn(s.id),i.push({id:s.id,name:s.name}))}return{newThreadsIn:i,team:r}}setThreadsOff(e,n){let r=e;const i=[];for(const o of this.events)if(o.off===n){const s=r.getAllActiveThreads().find(({name:a})=>a===o.threadName);s!==void 0&&(r=r.setOff(s.id),i.push({id:s.id,name:s.name}))}return{newThreadsOff:i,team:r}}}const u=t=>{const e=Number.parseInt(document.querySelector(t)?.value??"1",10);return Number.isNaN(e)?0:e},$=(t,e,n,r)=>{const{timeEvents:i,structureEvents:o}=he(t,e,n,r),s=crypto.randomUUID();N(i,s),O(o,s);const a=ge(i);return B(a,s),s};document.addEventListener("DOMContentLoaded",()=>{document.querySelector("#calculate-button")?.addEventListener("click",()=>{const r=Re(),i=$(r,Ce(),M(),P());window.open(`/TeamSpirit/flow/flow.html?id=${i}`),window.open(`/TeamSpirit/time-sequence/time-sequence.html?id=${i}`);const o=be(),s=$(o,Se(),M(),P());window.open(`/TeamSpirit/flow/flow.html?id=${s}`),window.open(`/TeamSpirit/time-sequence/time-sequence.html?id=${s}`)}),document.querySelector("#generate-devs-button")?.addEventListener("click",()=>{const r=document.getElementById("devs-container"),i=u("#dev-count-input"),o=Array.from({length:i},(s,a)=>U(a));r?.replaceChildren(...o)}),document.querySelector("#generate-user-stories-button")?.addEventListener("click",()=>{const r=document.getElementById("user-stories-container"),i=u("#user-story-count-input"),o=Array.from({length:i},(s,a)=>F(a));r?.replaceChildren(...o)}),document.querySelector("#team-modificator")?.addEventListener("change",r=>{if(r.target.value==="custom"){const o=document.querySelector("#team-modificator-events");o&&(o.style.display="block")}else{const o=document.querySelector("#team-modificator-events");o&&(o.style.display="none")}});let t=0;document.querySelector("#team-modificator-add-event-button")?.addEventListener("click",r=>{const i=_(t);r.target.parentElement?.append(i),t++}),document.querySelector("#bug-generator")?.addEventListener("change",r=>{if(r.target.value==="custom"){const o=document.querySelector("#bug-generator-events");o&&(o.style.display="block")}else{const o=document.querySelector("#bug-generator-events");o&&(o.style.display="none")}});let e=0;document.querySelector("#bug-generator-add-event-button")?.addEventListener("click",r=>{const i=k(e);r.target.parentElement?.append(i),e++}),document.querySelector("#priority-modificator")?.addEventListener("change",r=>{if(r.target.value==="custom"){const o=document.querySelector("#priority-modificator-events");o&&(o.style.display="block")}else{const o=document.querySelector("#priority-modificator-events");o&&(o.style.display="none")}});let n=0;document.querySelector("#priority-modificator-add-event-button")?.addEventListener("click",r=>{const i=G(n);r.target.parentElement?.append(i),n++})});const M=()=>{const t=document.querySelector("#bug-generator")?.value;if(t==="random")return new X(()=>Math.random(),()=>Math.random(),()=>Math.random());if(t==="custom"){const e=document.querySelectorAll("#bug-generator-events div"),n=[];for(const r of e)n.push({time:u(`#${r.id}-time-input`),complexity:u(`#${r.id}-complexity-input`),reviewComplexity:u(`#${r.id}-review-complexity-input`),priority:u(`#${r.id}-priority-input`)});return new W(n)}return V},P=()=>{const t=document.querySelector("#team-modificator")?.value;if(t==="random")return new Ie(()=>Math.random());if(t==="custom"){const e=document.querySelectorAll("#team-modificator-events div"),n=[];for(const r of e)n.push({off:u(`#${r.id}-off-input`),in:u(`#${r.id}-in-input`),threadName:document.querySelector(`#${r.id}-thread-name-input`)?.value??""});return new Ee(n)}return xe},be=()=>{const t=u("#user-story-count-input");return new A(Array.from({length:t},(e,n)=>({id:n,name:`US${n}`,complexity:u(`#complexity-input-${n}`),review:{reviewers:new Map,reviewComplexity:u(`#review-complexity-input-${n}`)},state:"Todo",threadId:void 0,progression:0,timeDone:0,priority:u(`#priority-input-${n}`)})))},Re=()=>{const t=u("#user-story-count-input");return new A(Array.from({length:t},(e,n)=>({id:n,name:`US${n}`,complexity:u(`#complexity-input-${n}`),review:D,state:"Todo",threadId:void 0,progression:0,timeDone:0,priority:u(`#priority-input-${n}`)})))},Se=()=>{const t=u("#dev-count-input"),e=u("#reviewers-input"),n=Array.from({length:t},(r,i)=>({id:i,name:`thread${i}`,power:u(`#power-input-${i}`),inTime:0,offTime:0,off:!1}));return new g(n,e)},Ce=()=>{const t=u("#dev-count-input"),e=Array.from({length:t},(n,r)=>({id:r,name:`thread${r}`,power:u(`#power-input-${r}`),inTime:0,offTime:0,off:!1}));return new y(e)};
