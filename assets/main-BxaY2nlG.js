import{s as P,a as N,b as O}from"./session-storage-Om7Yksbp.js";const v=(t,e)=>{const n=document.createElement("input");return n.id=t,n.type="number",n.min="1",n.value=e.toString(),n},f=(t,e)=>{const n=document.createElement("label");return n.textContent=t,n.htmlFor=e,n},q=t=>{const e=document.createElement("span");e.id=`dev-identifier-${t}`,e.textContent=t.toString();const n=`power-input-${t}`,r=f("Power",n),i=v(n,1),o=document.createElement("div");return o.append(e,r,i),o},L=t=>{const e=document.createElement("span");e.id=`user-story-identifier-${t}`,e.textContent=t.toString();const n=`complexity-input-${t}`,r=f("Complexity",n),i=v(n,5),o=`review-complexity-input-${t}`,s=f("Review complexity",o),a=v(o,2),c=document.createElement("div");return c.append(e,r,i,s,a),c},B=t=>{const e=`team-modificator-event-${t}-off-input`,n=f("Off",e),r=v(e,3),i=`team-modificator-event-${t}-in-input`,o=f("In",i),s=v(i,5),a=`team-modificator-event-${t}-thread-name-input`,c=f("Thread name",a),d=document.createElement("input");d.id=a;const m=document.createElement("button");m.textContent="Remove",m.id=`remove-event-button-${t}`,m.addEventListener("click",h=>{h.target.parentElement?.remove()});const l=document.createElement("div");return l.id=`team-modificator-event-${t}`,l.append(c,d,n,r,o,s,m),l},U=t=>{const e=`bug-generator-event-${t}-time-input`,n=f("Time",e),r=v(e,3),i=`bug-generator-event-${t}-complexity-input`,o=f("Complexity",i),s=v(i,1),a=`bug-generator-event-${t}-review-complexity-input`,c=f("Review complexity",a),d=v(a,1),m=document.createElement("button");m.textContent="Remove",m.id=`remove-event-button-${t}`,m.addEventListener("click",h=>{h.target.parentElement?.remove()});const l=document.createElement("div");return l.id=`bug-generator-event-${t}`,l.append(n,r,c,d,o,s,m),l},F=(t,e,n,r)=>{const o=(6-n)/5,a=t/5,c=.4*o*a,d=2+t,m=d/2,l=d/2.5,h=Math.exp(-(((e-m)/l)**2)),y=1.5*Math.exp(-.4*r);return c*h*y},_={generate(t,e,n){return[]}};class G{bugEvents;bugCount=0;constructor(e){this.bugEvents=e}generate(e,n,r){const i=I(e).length;return this.bugEvents.filter(o=>o.time===r).map(o=>{const s={id:i+this.bugCount,name:`bug-${this.bugCount}`,complexity:o.complexity,progression:0,review:{reviewers:new Map,reviewComplexity:o.reviewComplexity},state:"Todo",threadId:void 0,timeDone:0};return this.bugCount++,s})}}class z{bugCount=0;creationRandomProvider;complexityRandomProvider;constructor(e,n){this.creationRandomProvider=e,this.complexityRandomProvider=n}generate(e,n,r){return e.userStoriesDone.map(i=>ce(this.creationRandomProvider,i,n,r)?i:null).filter(i=>i!==null).map((i,o)=>{const s=I(e).length+o,a=`bug-${this.bugCount++}`,c=this.complexityRandomProvider();return{id:s,name:a,complexity:Math.max(1,Math.floor(c*i.complexity)),progression:0,review:{reviewComplexity:Math.max(1,Math.floor(c*i.review.reviewComplexity)),reviewers:new Map},threadId:void 0,state:"Todo",timeDone:0}})}}const $={reviewComplexity:1,reviewers:new Map},K=(t,e)=>t.reviewers.get(e.id)??0,V=(t,e,n)=>{const{reviewers:r}=t;return r.size<n&&!r.has(e.id)},W=(t,e,n)=>{const r=t.reviewers,i=r.get(e.id);return r.has(e.id)&&i!==n},X=(t,e,n)=>t.reviewers.size>=n&&[...t.reviewers.values()].filter(r=>r===e).length>=n,k=(t,e,n)=>n!==t.reviewers.size&&[...t.reviewers.values()].every(r=>r===e),j=(t,e,n)=>{const r=new Map(t.reviewers).set(e.id,n);return{...t,reviewers:r}},T={id:-1,name:"idle",complexity:0,progression:0,review:$,threadId:void 0,state:"Done",timeDone:0},H=(t,e)=>({...t,progression:Math.min(t.progression+e.power,t.complexity),threadId:e.id,state:"InProgress"}),J=(t,e,n)=>({...t,state:"Done",threadId:e,timeDone:n}),Q=(t,e)=>({...t,state:"Done",timeDone:e}),E=(t,e)=>({...t,state:"ToReview",threadId:e}),Y=(t,e)=>{const n=t.review,r=K(n,e),i=Math.min(r+e.power,n.reviewComplexity),o=j(n,e,i);return{...t,state:"Review",review:o}},Z=t=>t.progression===t.complexity,b=(t,e)=>X(t.review,t.review.reviewComplexity,e),ee=(t,e)=>t.state==="InProgress"&&t.threadId===e.id,te=(t,e)=>t.state!=="Review"||t.threadId===e.id?!1:W(t.review,e,t.review.reviewComplexity),ne=(t,e,n)=>t.state==="Review"&&t.threadId!==e.id&&V(t.review,e,n),re=(t,e)=>t.state==="ToReview"&&t.threadId!==e.id,ie=t=>t.state==="Todo";class D{userStoriesRemaining;userStoriesDone=[];constructor(e){this.userStoriesRemaining=e}}const I=t=>[...t.userStoriesRemaining,...t.userStoriesDone],oe=(t,e,n)=>{let r=t.userStoriesRemaining.findIndex(i=>ee(i,e));if(r===-1&&(r=t.userStoriesRemaining.findIndex(i=>te(i,e))),r===-1&&(r=t.userStoriesRemaining.findIndex(i=>ne(i,e,n))),r===-1){let i=Number.MAX_VALUE;t.userStoriesRemaining.forEach((o,s)=>{if(re(o,e)){const a=Math.abs(o.review.reviewComplexity-e.power);a<i&&(i=a,r=s)}})}if(r===-1){let i=Number.MAX_VALUE;t.userStoriesRemaining.forEach((o,s)=>{if(ie(o)){const a=Math.abs(o.complexity-e.power);a<i&&(i=a,r=s)}})}return r!==-1?t.userStoriesRemaining.splice(r,1)[0]:T},se=(t,e)=>t.userStoriesRemaining.filter(n=>n.state==="Review").filter(n=>k(n.review,n.review.reviewComplexity,e)),x=(t,e)=>{t.state==="Done"?e.userStoriesDone.push(t):e.userStoriesRemaining.push(t)},ae=t=>t.userStoriesRemaining.length>0,ce=(t,e,n,r)=>{const i=t(),o=n.getEffectiveThreads().find(s=>s.id===e.threadId)?.power??0;return i<F(e.complexity,r-e.timeDone,o,e.review.reviewers.size)},de=(t,e)=>{const n=I(t).map(i=>({time:1,id:i.id,name:i.name,action:"CreateUserStory"}));return[...e.getEffectiveThreads().map(i=>({time:1,id:i.id,name:i.name,action:"CreateThread"})),...n]},p=(t,e,n)=>({time:t,userStoryId:e.id,threadId:n,state:e.state}),me=(t,e,n)=>{const r=[],i=[];for(const o of t.getEffectiveActiveThreads()){const s=oe(e,o,t.getReviewersNeeded());if(s===T){T.threadId=o.id,r.push(p(n,T,o.id));continue}if(["ToReview","Review"].includes(s.state)){const a=Y(s,o);if(r.push(p(n,a,o.id)),b(a,t.getReviewersNeeded())){const c=J(s,a.threadId,n);r.push(p(n,c,c.threadId)),i.push(c)}else x(a,e)}else if(["Todo","InProgress"].includes(s.state)){const a=H(s,o);if(r.push(p(n,a,o.id)),!Z(a))i.push(a);else if(b(a,t.getReviewersNeeded())){let c=Q(a,n);c=t.addImplicitsReviewers(c),r.push(p(n,c,o.id)),i.push(c)}else{const c=E(a,o.id);r.push(p(n,c,o.id)),i.push(c)}}}return se(e,t.getReviewersNeeded()).forEach(o=>{const s=E(o,o.threadId);r.push(p(n,s,o.threadId))}),i.forEach(o=>{x(o,e)}),r},ue=(t,e,n,r)=>{const i=[];let o=1,s=e;const a=de(t,s);for(;ae(t);){n.generate(t,s,o).forEach(m=>{a.push({time:o,name:m.name,id:m.id,action:"CreateUserStory"}),x(m,t)});const c=r.setThreadsOff(s,o);s=c.team,c.newThreadsOff.forEach(m=>{a.push({time:o,name:m.name,id:m.id,action:"ThreadOff"})});const d=r.setThreadsIn(s,o);s=d.team,d.newThreadsIn.forEach(m=>{a.push({time:o,name:m.name,id:m.id,action:"ThreadIn"})}),i.push(...me(s,t,o)),o++,s=s.updateTimes()}return{timeEvents:i,structureEvents:a}},le=t=>t.reduce((n,r)=>n+r,0)/t.length,fe=t=>{const e=new Map,n=[],r=[];let i=1;for(;;){const o=t.filter(d=>d.time===i);if(o.length===0)break;const s=new Set(o.filter(d=>d.state==="InProgress").map(d=>d.userStoryId));for(const d of s)e.has(d)||e.set(d,0);e.forEach((d,m)=>{e.set(m,d+1)});const a=new Set(o.filter(d=>d.state==="Done").map(d=>d.userStoryId));for(const d of a){const m=e.get(d);m&&n.push(m),e.delete(d)}const c=le(n);r.push({time:i,leadTime:c}),i++}return r},R=t=>{const e=t.map(r=>r.power).reduce((r,i)=>r+i,0);return[{id:0,name:"mob",power:Math.round(e/t.length),inTime:0,offTime:0,off:!1}]},A=t=>t.map(e=>e.off?{...e,offTime:e.offTime+1}:{...e,inTime:e.inTime+1});class w{threads=[];reviewersNeeded;constructor(e,n=Math.ceil(e.length/2)){this.threads=e,this.reviewersNeeded=n}addImplicitsReviewers(e){return e}updateTimes(){return new w(A(this.threads),this.reviewersNeeded)}getReviewersNeeded(){const e=this.getEffectiveActiveThreads().length;return this.reviewersNeeded>=e?e-1:this.reviewersNeeded}setOff(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!0,inTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new w(i,this.reviewersNeeded)}setIn(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!1,offTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new w(i,this.reviewersNeeded)}getAllActiveThreads(){return this.threads.filter(e=>!e.off)}getEffectiveActiveThreads(){return this.getAllActiveThreads()}getEffectiveThreads(){return this.getEffectiveActiveThreads()}getThreadsOff(){return this.threads.filter(e=>e.off)}}class g{threads;constructor(e){this.threads=e}addImplicitsReviewers(e){const n=this.getAllActiveThreads();n.shift();const r=new Map(n.map(i=>[i.id,e.review.reviewComplexity]));return{...e,review:{...e.review,reviewers:r}}}getThreadsOff(){return this.threads.filter(e=>e.off)}getReviewersNeeded(){return 0}setOff(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!0,inTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new g(i)}setIn(e){const n=this.threads.findIndex(o=>o.id===e),r={...this.threads[n],off:!1,offTime:0},i=this.threads.map((o,s)=>s===n?r:o);return new g(i)}getAllActiveThreads(){return this.threads.filter(e=>!e.off)}getEffectiveActiveThreads(){return R(this.getAllActiveThreads())}getEffectiveThreads(){return R(this.threads)}updateTimes(){return new g(A(this.threads))}}const ve=t=>{const r={};for(const i of t){const o=Math.min(1,(i.inTime/30)**2.2),s=(6-i.power)/5;r[i.id]=Math.min(.5,o*s*.5)}return r},pe=t=>{const e={};for(const n of t){if(n.offTime<=4){e[n.id]=.3+.2*n.offTime/4;continue}if(n.offTime<=10){e[n.id]=.2;continue}const r=1,i=.2+(1-Math.exp(-.3*(n.offTime-10)));e[n.id]=Math.min(i,r)}return e};class he{randomProvider;constructor(e){this.randomProvider=e}setThreadsIn(e,n){let r=e;const i=e.getThreadsOff(),o=[],s=pe(i);return i.forEach(a=>{this.randomProvider()<s[a.id]&&(o.push({id:a.id,name:a.name}),r=e.setIn(a.id))}),{team:r,newThreadsIn:o}}setThreadsOff(e,n){const r=e.getAllActiveThreads();if(r.length===1)return{team:e,newThreadsOff:[]};let i=e;const o=[],s=ve(r);return r.forEach(a=>{this.randomProvider()<s[a.id]&&(o.push({id:a.id,name:a.name}),i=e.setOff(a.id))}),{team:i,newThreadsOff:o}}}const we={setThreadsIn(t){return{newThreadsIn:[],team:t}},setThreadsOff(t){return{newThreadsOff:[],team:t}}};class ge{events;constructor(e){this.events=e}setThreadsIn(e,n){let r=e;const i=[];for(const o of this.events)if(o.in===n){const s=r.getThreadsOff().find(({name:a})=>a===o.threadName);s!==void 0&&(r=r.setIn(s.id),i.push({id:s.id,name:s.name}))}return{newThreadsIn:i,team:r}}setThreadsOff(e,n){let r=e;const i=[];for(const o of this.events)if(o.off===n){const s=r.getAllActiveThreads().find(({name:a})=>a===o.threadName);s!==void 0&&(r=r.setOff(s.id),i.push({id:s.id,name:s.name}))}return{newThreadsOff:i,team:r}}}const u=t=>{const e=Number.parseInt(document.querySelector(t)?.value??"1",10);return Number.isNaN(e)?0:e},S=(t,e,n,r)=>{const{timeEvents:i,structureEvents:o}=ue(t,e,n,r),s=crypto.randomUUID();P(i,s),N(o,s);const a=fe(i);return O(a,s),s};document.addEventListener("DOMContentLoaded",()=>{document.querySelector("#calculate-button")?.addEventListener("click",()=>{const n=ye(),r=S(n,Ie(),C(),M());window.open(`/TeamSpirit/flow/flow.html?id=${r}`),window.open(`/TeamSpirit/time-sequence/time-sequence.html?id=${r}`);const i=Te(),o=S(i,xe(),C(),M());window.open(`/TeamSpirit/flow/flow.html?id=${o}`),window.open(`/TeamSpirit/time-sequence/time-sequence.html?id=${o}`)}),document.querySelector("#generate-devs-button")?.addEventListener("click",()=>{const n=document.getElementById("devs-container"),r=u("#dev-count-input"),i=Array.from({length:r},(o,s)=>q(s));n?.replaceChildren(...i)}),document.querySelector("#generate-user-stories-button")?.addEventListener("click",()=>{const n=document.getElementById("user-stories-container"),r=u("#user-story-count-input"),i=Array.from({length:r},(o,s)=>L(s));n?.replaceChildren(...i)}),document.querySelector("#team-modificator")?.addEventListener("change",n=>{if(n.target.value==="custom"){const i=document.querySelector("#team-modificator-events");i&&(i.style.display="block")}else{const i=document.querySelector("#team-modificator-events");i&&(i.style.display="none")}});let t=0;document.querySelector("#team-modificator-add-event-button")?.addEventListener("click",n=>{const r=B(t);n.target.parentElement?.append(r),t++}),document.querySelector("#bug-generator")?.addEventListener("change",n=>{if(n.target.value==="custom"){const i=document.querySelector("#bug-generator-events");i&&(i.style.display="block")}else{const i=document.querySelector("#bug-generator-events");i&&(i.style.display="none")}});let e=0;document.querySelector("#bug-generator-add-event-button")?.addEventListener("click",n=>{const r=U(e);n.target.parentElement?.append(r),e++})});const C=()=>{const t=document.querySelector("#bug-generator")?.value;if(t==="random")return new z(()=>Math.random(),()=>Math.random());if(t==="custom"){const e=document.querySelectorAll("#bug-generator-events div"),n=[];for(const r of e)n.push({time:u(`#${r.id}-time-input`),complexity:u(`#${r.id}-complexity-input`),reviewComplexity:u(`#${r.id}-review-complexity-input`)});return new G(n)}return _},M=()=>{const t=document.querySelector("#team-modificator")?.value;if(t==="random")return new he(()=>Math.random());if(t==="custom"){const e=document.querySelectorAll("#team-modificator-events div"),n=[];for(const r of e)n.push({off:u(`#${r.id}-off-input`),in:u(`#${r.id}-in-input`),threadName:document.querySelector(`#${r.id}-thread-name-input`)?.value??""});return new ge(n)}return we},Te=()=>{const t=u("#user-story-count-input");return new D(Array.from({length:t},(e,n)=>({id:n,name:`US${n}`,complexity:u(`#complexity-input-${n}`),review:{reviewers:new Map,reviewComplexity:u(`#review-complexity-input-${n}`)},state:"Todo",threadId:void 0,progression:0,timeDone:0})))},ye=()=>{const t=u("#user-story-count-input");return new D(Array.from({length:t},(e,n)=>({id:n,name:`US${n}`,complexity:u(`#complexity-input-${n}`),review:$,state:"Todo",threadId:void 0,progression:0,timeDone:0})))},xe=()=>{const t=u("#dev-count-input"),e=u("#reviewers-input"),n=Array.from({length:t},(r,i)=>({id:i,name:`thread${i}`,power:u(`#power-input-${i}`),inTime:0,offTime:0,off:!1}));return new w(n,e)},Ie=()=>{const t=u("#dev-count-input"),e=Array.from({length:t},(n,r)=>({id:r,name:`thread${r}`,power:u(`#power-input-${r}`),inTime:0,offTime:0,off:!1}));return new g(e)};
